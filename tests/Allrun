#!/usr/bin/env bash

if [ -z "$WM_PROJECT" ]; then
  echo "OpenFOAM environment not found, forgot to source the OpenFOAM bashrc?"
  exit 1
fi

# check if we need to download input.tar.gz
if [ -f "input.tar.gz" ]; then
  echo "input.tar.gz already exists."
else
  echo "Downloading input.tar.gz"
  wget https://github.com/dafoam/files/releases/download/v1.0.0/input.tar.gz --no-check-certificate
fi

function runTests() 
{
  rm -rf input DAFoam_Test_${1}.txt
  tar -zxf input.tar.gz
  mpirun -np 4 python runTests_${1}.py $@ | tee DAFoam_Test_${1}.txt 
  if [ "${PIPESTATUS[0]}" -ne "0" ]; then 
    echo "${1}: Failed!"
    exit 1
  fi
  python testFuncs.py refs/DAFoam_Test_${1}Ref.txt DAFoam_Test_${1}.txt
  if [ "$?" -ne "0" ]; then 
    echo "${1}: Failed!"
    exit 1
  else
    echo "${1}: Success!"
  fi
}

runTests Integration
runTests DASimpleFoam
runTests DASimpleTFoam
runTests DAPisoFoam
runTests DARhoSimpleFoam
runTests DARhoSimpleFoamUBend
runTests DARhoSimpleCFoam
runTests DATurboFoamSubsonic
runTests DATurboFoamTransonic
runTests DASolidDisplacementFoam

echo " "
echo "************************************************************"
echo "**************** All DAFoam tests passed! ******************"
echo "************************************************************"
echo " "
